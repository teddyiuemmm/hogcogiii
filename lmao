repeat task.wait() until game:IsLoaded()

local Players = game:GetService("Players")
local TeleportService = game:GetService("TeleportService")
local HttpService = game:GetService("HttpService")
local LocalPlayer = Players.LocalPlayer

local function getRootPart()
    local character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
    return character:WaitForChild("HumanoidRootPart")
end

local function findNearestDefault()
    local pickups = workspace:FindFirstChild("Pickups") or workspace:FindFirstChild("ActivePickups")
    if not pickups then return nil end
    local nearest, minDist = nil, math.huge
    local hrpPos = getRootPart().Position
    for _, v in ipairs(pickups:GetChildren()) do
        if v:IsA("BasePart") and v.Name == "Default" then
            local dist = (v.Position - hrpPos).Magnitude
            if dist < minDist then
                minDist = dist
                nearest = v
            end
        end
    end
    return nearest
end

local function serverHop()
    local success, result = pcall(function()
        return HttpService:JSONDecode(game:HttpGet("https://games.roblox.com/v1/games/"..game.PlaceId.."/servers/Public?sortOrder=Asc&limit=100"))
    end)
    if success and result and result.data then
        for _, server in result.data do
            if server.playing < server.maxPlayers and server.id ~= game.JobId then
                TeleportService:TeleportToPlaceInstance(game.PlaceId, server.id)
                return
            end
        end
    end
end

local function autoTeleportLoop()
    local utility = workspace:FindFirstChild("Utility")
    local obbyColliders = utility and utility:FindFirstChild("ObbyColliders")
    local hrp = getRootPart()

    -- TP GameStart
    if obbyColliders then
        local gameStart = obbyColliders:FindFirstChild("GameStart")
        if gameStart then
            hrp.CFrame = gameStart.CFrame + Vector3.new(0, 1, 0)
            task.wait()
        end
    end

    -- Bám Default liên tục
    while findNearestDefault() do
        local nearest = findNearestDefault()
        if nearest then
            hrp.CFrame = nearest.CFrame + Vector3.new(0, 1, 0)
        end
        task.wait()
    end

    -- Chờ 148s
    task.wait(148)

    -- TP StopGame
    local stopGame = obbyColliders and obbyColliders:FindFirstChild("StopGame")
    if stopGame then
        hrp.CFrame = stopGame.CFrame + Vector3.new(0, 1, 0)
        task.wait()
    end

    -- TP Portal_to_Wc + check 160s timeout
    local portal = utility
        and utility:FindFirstChild("Teleporters")
        and utility.Teleporters:FindFirstChild("Portal_to_Wc")
        and utility.Teleporters.Portal_to_Wc:FindFirstChild("Collision")

    if portal then
        hrp.CFrame = portal.CFrame + Vector3.new(0, 1, 0)
        task.wait(0.5)

        local startTime = tick()
        while tick() - startTime < 160 do
            if (getRootPart().Position - portal.Position).Magnitude < 10 then
                break
            end
            task.wait(0.5)
        end

        if (getRootPart().Position - portal.Position).Magnitude >= 10 then
            TeleportService:Teleport(game.PlaceId) -- rejoin nếu chưa tới portal
            return
        end
    end

    -- Serverhop
    serverHop()
end

task.spawn(autoTeleportLoop)
